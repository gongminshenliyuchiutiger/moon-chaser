<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€æœˆç¥æ”æ‰‹éŠæˆ²ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f20; /* æ·±å¤œè— */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            color: #f0f4f8;
            transition: background-color 0.5s;
            position: relative; /* ç‚ºäº†å‰ç¥¥ç‰©çš„fixedå®šä½ */
        }

        #game-wrapper {
            background-color: #1a1a38; /* éŠæˆ²ä¸»å®¹å™¨èƒŒæ™¯ */
            border-radius: 1.5rem;
            box-shadow: 0 10px 60px rgba(0, 0, 0, 0.7);
            width: 95vw;
            max-width: 700px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼ŒéŸ¿æ‡‰å¼è¨­è¨ˆ */
            padding: 1.5rem;
            z-index: 10; 
        }

        #canvas-container {
            position: relative;
            background: linear-gradient(180deg, #1c1c4e 0%, #0f0f20 100%);
            border-radius: 1rem;
            border: 4px solid #f9d71c; /* é‡‘è‰²é‚Šæ¡† */
            overflow: hidden;
            touch-action: none; /* ç¦ç”¨ç€è¦½å™¨è§¸æ§è¡Œç‚º */
            min-height: 400px; /* ç¢ºä¿å®¹å™¨æœ‰é«˜åº¦ï¼Œé¿å…é–ƒçˆ */
        }
        
        #gameCanvas {
            display: block;
            width: 100%;
            height: 400px;
            cursor: pointer;
        }

        .status-bar-item {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
        }

        .game-button {
            padding: 0.6rem 2rem;
            background: linear-gradient(145deg, #f9d71c, #ffcc00);
            color: #1a1a38;
            font-weight: 900;
            font-size: 1.1rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 204, 0, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 204, 0, 0.7);
        }

        /* å‰ç¥¥ç‰©æ¨£å¼ (é é¢å·¦ä¸‹è§’å›ºå®š) */
        #mascot-fixed {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 80px; 
            height: auto;
            cursor: pointer;
            z-index: 5; 
            transition: transform 0.2s ease-out, filter 0.2s ease-out; 
        }

        /* æŠ–å‹•å‹•ç•« */
        @keyframes neon-shake {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            10% { transform: translate(-1px, -1px) rotate(-1deg); }
            20% { transform: translate(1px, 1px) rotate(1deg); }
            30% { transform: translate(-1px, 1px) rotate(-1deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, -1px) rotate(-1deg); }
            60% { transform: translate(1px, 1px) rotate(1deg); }
            70% { transform: translate(-1px, 1px) rotate(-1deg); }
            80% { transform: translate(1px, -1px) rotate(1deg); }
            90% { transform: translate(-1px, -1px) rotate(-1deg); }
        }

        #mascot-fixed:hover {
            animation: neon-shake 0.8s infinite linear; 
            filter: drop-shadow(0 0 5px #ff00ff) 
                    drop-shadow(0 0 10px #00ffff) 
                    drop-shadow(0 0 15px #ffcc00) 
                    drop-shadow(0 0 20px #00ff00); 
        }

        /* ç‰ˆæ¬Šä¿¡æ¯æ¨£å¼ */
        #copyright {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
            z-index: 10;
        }

        /* éŠæˆ²èªªæ˜æ›¸æ¨£å¼ */
        #instructions-modal {
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 50;
        }
        #instructions-modal .bg-gray-800 {
            max-height: 90vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            overflow-y: auto; /* è¶…å‡ºéƒ¨åˆ†æ»¾å‹• */
        }

        /* éŠæˆ²æŒ‰éˆ•è¦†è“‹å±¤ */
        #game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° canvas */
            z-index: 20; 
            background: rgba(0,0,0,0.3); /* è¼•å¾®èƒŒæ™¯ï¼Œè®“æ–‡å­—æ›´æ¸…æ™° */
            border-radius: 1rem; /* åŒ¹é… canvas å®¹å™¨ */
            transition: opacity 0.3s ease-in-out; /* å¹³æ»‘éš±è—/é¡¯ç¤º */
            opacity: 1;
        }

        #game-overlay.hidden {
            opacity: 0;
            pointer-events: none; /* å®Œå…¨éš±è—æ™‚ä¸éŸ¿æ‡‰é»æ“Š */
            display: none; /* å¯¦éš›ä¸Šéš±è—å…ƒç´  */
        }
        /* ç•¶ hidden é¡åˆ¥å­˜åœ¨æ™‚æ‰æ‡‰ç”¨ display: flex */
        #game-overlay:not(.hidden) {
            display: flex; 
        }


        #game-overlay > * {
            pointer-events: auto; /* æ¢å¾©æŒ‰éˆ•å’Œè¨Šæ¯çš„å¯é»æ“Šæ€§ */
        }

        /* ä¸»æ¨™é¡Œå…§çš„èªªæ˜æŒ‰éˆ• */
        #title-instructions-button {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: #facc15; /* yellow-400 */
            transition: color 0.2s;
        }
        #title-instructions-button:hover {
            color: #fde047; /* yellow-200 */
        }
        @media (min-width: 640px) { /* Small screens and up */
            #title-instructions-button {
                right: 1rem; /* å¢åŠ ä¸€äº›å³é‚Šè· */
            }
        }

        /* ç‰©å“å°åœ–æ¨™åœ¨æ–‡å­—ä¸­çš„æ¨£å¼ */
        .item-icon-inline {
            height: 1.5em; /* æ ¹æ“šæ–‡å­—å¤§å°èª¿æ•´é«˜åº¦ */
            width: auto;
            vertical-align: middle; /* å‚ç›´å±…ä¸­ */
            margin: 0 0.2em; /* å·¦å³é–“è· */
            display: inline-block; /* ç¢ºä¿å®ƒèƒ½èˆ‡æ–‡å­—ä¸¦æ’ */
        }
        /* ç¢ºä¿æ¯å€‹ä»»å‹™é …ç›®çš„åœ–ç‰‡å’Œæ–‡å­—ä¸æœƒæ–·é–‹ */
        .mission-item-wrapper {
            display: inline-flex; /* ä½¿ç”¨ flex è®“å…§å®¹ä¸¦æ’ */
            align-items: center; /* å‚ç›´å±…ä¸­å°é½Š */
            white-space: nowrap; /* é˜²æ­¢å…§éƒ¨å…§å®¹æ›è¡Œ */
            margin-right: 1rem; /* å„å€‹ä»»å‹™é …ç›®ä¹‹é–“çš„é–“è· */
        }
        /* ä»»å‹™ç›®æ¨™å€çš„æ–‡å­— flex å®¹å™¨ */
        #mission-display .flex-wrap {
            display: flex;
            flex-wrap: wrap; /* å…è¨±æ•´é«”æ›è¡Œï¼Œä½†å–®å€‹é …ç›®ä¸æ›è¡Œ */
            gap: 0; /* ç§»é™¤é»˜èªçš„gapï¼Œç”±.mission-item-wrapperçš„margin-rightæ§åˆ¶ */
        }

        /* èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶å€ */
        #music-controls {
            background-color: #1a1a38;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            padding: 0.75rem 1.5rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        #music-controls.hidden {
            display: none;
        }
        #music-toggle-button {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: #facc15;
            transition: color 0.2s;
        }
        #music-toggle-button:hover {
            color: #fde047;
        }
        #music-volume-slider {
            width: 80px; /* å¯¬åº¦èª¿æ•´ */
            height: 8px;
            background: transparent; 
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none; 
            appearance: none;
        }
        /* é‡å° Webkit ç€è¦½å™¨ (Chrome, Safari) çš„æ»‘æ¡¿è»Œé“ */
        #music-volume-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: transparent; 
            border-radius: 4px;
            -webkit-appearance: none; 
        }
        /* é‡å° Firefox çš„æ»‘æ¡¿è»Œé“ */
        #music-volume-slider::-moz-range-track {
            width: 100%;
            height: 8px;
            background: transparent; 
            border-radius: 4px;
        }
        #music-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #f9d71c; /* yellow-400 */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(255, 204, 0, 0.7);
            margin-top: -4px; 
        }
        #music-volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #f9d71c; /* yellow-400 */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(255, 204, 0, 0.7);
        }

    </style>
</head>
<body>

    <div id="game-wrapper">
        <h1 class="text-3xl font-extrabold mb-4 text-center text-yellow-300 relative">
            é€æœˆç¥æ”æ‰‹éŠæˆ²ç³»çµ± 
            <button id="title-instructions-button" onclick="toggleInstructions()">
                <i class="fas fa-info-circle text-2xl"></i>
            </button>
        </h1>
        
        <!-- ç‹€æ…‹æ¬„ï¼šé—œå¡ã€æ™‚é–“ã€åˆ†æ•¸ -->
        <div class="flex justify-between items-center mb-4 p-2 bg-gray-700/50 rounded-xl">
            <div class="status-bar-item bg-blue-500/30">é—œå¡: <span id="level-display">0</span></div>
            <div class="status-bar-item bg-red-500/30 text-2xl">æ™‚é–“: <span id="timer-display">0.0</span>s</div>
            <div class="status-bar-item bg-green-500/30">å¾—åˆ†: <span id="score-display">0</span></div>
        </div>

        <!-- ä»»å‹™ç›®æ¨™å€ -->
        <div id="mission-display" class="mb-4 p-4 rounded-lg bg-yellow-900/40 border-l-4 border-yellow-400">
            <h2 class="text-xl font-bold mb-2 text-yellow-300"><i class="fas fa-bullseye"></i> ä»»å‹™ç›®æ¨™:</h2>
            <div class="flex flex-wrap text-lg">
                <p><i class="fas fa-camera-retro text-green-300"></i> æ•æ‰: <span id="targets" class="font-bold text-green-300">...</span></p>
                <p><i class="fas fa-ban text-red-300"></i> é¿é–‹: <span id="forbidden" class="font-bold text-red-300">...</span></p>
            </div>
            <p id="level-name" class="text-sm mt-2 italic text-gray-300">éŠæˆ²å°šæœªé–‹å§‹</p>
        </div>

        <!-- ç•«å¸ƒå®¹å™¨ -->
        <div id="canvas-container">
            <canvas id="gameCanvas"></canvas>
            <!-- éŠæˆ²è¨Šæ¯èˆ‡æŒ‰éˆ•è¦†è“‹å±¤ -->
            <div id="game-overlay">
                <p id="game-message" class="text-lg text-white mb-4 text-center drop-shadow-lg"></p>
                <button id="start-button" class="game-button"></button>
            </div>
        </div>

    </div>

    <!-- èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶å€ -->
    <div id="music-controls" class="mt-4 p-3 bg-gray-700/50 rounded-xl flex items-center gap-4">
        <button id="music-toggle-button" class="text-yellow-300 text-2xl">
            <i class="fas fa-volume-up"></i> <!-- åˆå§‹ç‚ºæ’­æ”¾ç‹€æ…‹ -->
        </button>
        <input type="range" id="music-volume-slider" min="0" max="1" step="0.05" value="0.3">
    </div>

    <!-- å‰ç¥¥ç‰©åœ–ç‰‡ (é é¢å·¦ä¸‹è§’å›ºå®š) -->
    <img id="mascot-fixed" src="image/LiyuChillGuy.svg" alt="å‰ç¥¥ç‰© LiyuChillGuy">

    <!-- ç‰ˆæ¬Šä¿¡æ¯ -->
    <div id="copyright">
        <p>Copyright Â© Liyuchiutiger Gongminshen</p>
    </div>

    <!-- éŠæˆ²èªªæ˜æ›¸ Modal -->
    <div id="instructions-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full text-white shadow-xl relative">
            <h2 class="text-2xl font-bold mb-4 text-yellow-300"><i class="fas fa-gamepad"></i> é€æœˆç¥æ”æ‰‹éŠæˆ²èªªæ˜</h2>
            <button class="absolute top-3 right-3 text-gray-400 hover:text-white text-3xl font-bold" onclick="toggleInstructions()">&times;</button>
            
            <p class="mb-3">æ­¡è¿ä¾†åˆ°ä¸­ç§‹è¿½å½±æ•æ‰æŒ‘æˆ°ï¼ä½ çš„ä»»å‹™æ˜¯åœ¨é™æ™‚å…§ï¼Œæ•æ‰åˆ°é—œå¡æŒ‡å®šçš„æ‰€æœ‰ã€Œç›®æ¨™ã€ï¼ŒåŒæ™‚ã€Œé¿é–‹ã€æ‰€æœ‰ç¦å¿Œç‰©å“ã€‚</p>
            
            <h3 class="text-xl font-bold mt-4 mb-2 text-blue-300"><i class="fas fa-crosshairs"></i> å¦‚ä½•éŠç©:</h3>
            <ul class="list-disc list-inside mb-3 space-y-1">
                <li>éŠæˆ²å€åŸŸå…§æœƒæ¼‚æµ®è‘—å„ç¨®ä¸­ç§‹å…ƒç´  (ä¾‹å¦‚ï¼š<span class="mission-item-wrapper"><img src="item/moon.svg" alt="æœˆäº®" class="item-icon-inline">æœˆäº®</span>ã€<span class="mission-item-wrapper"><img src="item/rabbit.svg" alt="ç‰å…”" class="item-icon-inline">ç‰å…”</span>ã€<span class="mission-item-wrapper"><img src="item/mooncake.svg" alt="æœˆé¤…" class="item-icon-inline">æœˆé¤…</span>ã€<span class="mission-item-wrapper"><img src="item/pomelo.svg" alt="æŸšå­" class="item-icon-inline">æŸšå­</span>ã€<span class="mission-item-wrapper"><img src="item/matcha.svg" alt="æŠ¹èŒ¶" class="item-icon-inline">æŠ¹èŒ¶</span>ã€<span class="mission-item-wrapper"><img src="item/bubbletea.svg" alt="çå¥¶" class="item-icon-inline">çç å¥¶èŒ¶</span>ã€<span class="mission-item-wrapper"><img src="item/dango.svg" alt="ç³°å­" class="item-icon-inline">ç³¯ç±³ç³°å­</span>)ã€‚</li>
                <li>é»æ“Šç•«é¢ä»»ä½•ä½ç½®ï¼Œå³æœƒè§¸ç™¼ä¸€æ¬¡ã€Œå…¨è¢å¹•å¿«ç…§ã€ã€‚</li>
                <li>å¦‚æœå¿«ç…§ä¸­å‡ºç¾ä»»ä½• <span class="mission-item-wrapper"><img src="item/egg.svg" alt="çˆ†æ°£ç‚¸è›‹" class="item-icon-inline">çˆ†æ°£ç‚¸è›‹</span> æˆ– <span class="mission-item-wrapper"><img src="item/tiger.svg" alt="è€è™" class="item-icon-inline">è€è™</span>ï¼Œä½ å°‡ç«‹å³å¤±æ•—ï¼</li>
                <li>å¦‚æœå¿«ç…§ä¸­åŒæ™‚å‡ºç¾æ‰€æœ‰ã€Œä»»å‹™ç›®æ¨™ã€ (ä¾‹å¦‚ï¼š<span class="mission-item-wrapper"><img src="item/moon.svg" alt="æœˆäº®" class="item-icon-inline">æœˆäº®</span>ã€<span class="mission-item-wrapper"><img src="item/rabbit.svg" alt="ç‰å…”" class="item-icon-inline">ç‰å…”</span>ã€<span class="mission-item-wrapper"><img src="item/mooncake.svg" alt="æœˆé¤…" class="item-icon-inline">æœˆé¤…</span>ã€<span class="mission-item-wrapper"><img src="item/bubbletea.svg" alt="çå¥¶" class="item-icon-inline">çç å¥¶èŒ¶</span>)ï¼Œä¸”æ²’æœ‰ä»»ä½•ç¦å¿Œç‰©å“ï¼Œä½ å°‡æˆåŠŸæ™‰ç´šï¼</li>
                <li>æ•æ‰ <span class="mission-item-wrapper"><img src="item/gms.svg" alt="å¿«æ¨‚é¯‰é­š" class="item-icon-inline">å¿«æ¨‚é¯‰é­š</span>å¯ç²å¾—é¡å¤–çå‹µåˆ†æ•¸ï¼Œä½†åƒ…é™åœ¨æˆåŠŸæ™‰ç´šçš„å›åˆï¼</li>
                <li>é»æ“Šã€Œä¸‹ä¸€é—œã€æˆ–ã€Œå†è©¦ä¸€æ¬¡ã€æ‰æœƒè®“ç‰©ä»¶é‡æ–°ç§»å‹•ã€‚å¦‚æœå¿«ç…§æ²’æœ‰å°è‡´æ™‰ç´šæˆ–å¤±æ•—ï¼Œæœƒå‡ºç¾ã€Œç¹¼çºŒæ•æ‰ã€æŒ‰éˆ•ï¼Œé»æ“Šå¾Œç‰©ä»¶ä¹Ÿæœƒæ¢å¾©ç§»å‹•ã€‚</li>
            </ul>

            <h3 class="text-xl font-bold mt-4 mb-2 text-green-300"><i class="fas fa-star"></i> éŠæˆ²æç¤º:</h3>
            <ul class="list-disc list-inside space-y-1">
                <li>æ¯å€‹é—œå¡çš„æ™‚é–“å’Œç›®æ¨™éƒ½ä¸åŒï¼Œè«‹ä»”ç´°æŸ¥çœ‹ã€‚</li>
                <li>éŠæˆ²æœƒéš¨è‘—é—œå¡æ¨é€²è€Œå¢åŠ é›£åº¦ï¼Œç‰©å“ç§»å‹•é€Ÿåº¦æœƒè®Šå¿«ï¼</li>
                <li>ç²¾æº–åˆ¤æ–·å¿«ç…§æ™‚æ©Ÿæ˜¯ç²å‹çš„é—œéµï¼</li>
            </ul>
            <button class="game-button mt-6 w-full" onclick="toggleInstructions()">æˆ‘çŸ¥é“äº†ï¼</button>
        </div>
    </div>

    <!-- èƒŒæ™¯éŸ³æ¨‚ Audio Element -->
    <audio id="background-music" loop preload="auto">
        <source src="audio/bgm.mp3" type="audio/mpeg">
        <!-- å¦‚æœéœ€è¦å…¼å®¹æ›´å¤šç€è¦½å™¨ï¼Œå¯ä»¥æ·»åŠ  OGG æ ¼å¼ï¼š -->
        <!-- <source src="audio/bgm.ogg" type="audio/ogg"> -->
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéŸ³é »å…ƒç´ ã€‚è«‹ç¢ºèª `audio/bgm.mp3` æ–‡ä»¶å­˜åœ¨ã€‚
    </audio>

    <script>
        // --- éŠæˆ²è¨­å®šèˆ‡åˆå§‹åŒ– ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const TIMER_DISPLAY = document.getElementById('timer-display');
        const LEVEL_DISPLAY = document.getElementById('level-display');
        const SCORE_DISPLAY = document.getElementById('score-display');
        const TARGETS_DISPLAY = document.getElementById('targets');
        const FORBIDDEN_DISPLAY = document.getElementById('forbidden');
        const LEVEL_NAME_DISPLAY = document.getElementById('level-name');
        const GAME_MESSAGE = document.getElementById('game-message');
        const START_BUTTON = document.getElementById('start-button');
        const GAME_OVERLAY = document.getElementById('game-overlay'); 
        const SCORE_PER_CAPTURE = 100;
        const BONUS_ITEM_SCORE = 200; 
        const SCALE_FACTOR = 2; 

        let CANVAS_WIDTH, CANVAS_HEIGHT;
        let gameState = 'ready'; 
        let gameObjects = [];
        let timerInterval;
        let timeLeft = 0;
        let score = 0;
        let currentLevelIndex = 0;
        let captureEffect = null; 
        let highlightEffect = null; 
        let bonusMessages = []; 
        let objectsAreFrozen = false; 

        // --- Web Audio API (éŸ³æ•ˆ) ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        // æ­¤æ——æ¨™ç¾åœ¨ç”¨æ–¼è¿½è¹¤éŸ³æ¨‚æ˜¯å¦å·²ç¶“æˆåŠŸæ’­æ”¾éè‡³å°‘ä¸€æ¬¡ (éè¢«ç€è¦½å™¨é˜»æ“‹çš„ç‹€æ…‹)
        let backgroundMusicPlayedOnceSuccessfully = false; 

        function playSound(frequency, duration, type = 'sine', decayTime = 0.1, volume = 0.5) {
            if (!audioContext || audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    _createAndPlayOscillator();
                });
            } else {
                _createAndPlayOscillator();
            }

            function _createAndPlayOscillator() {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = type; 
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

                gainNode.gain.setValueAtTime(volume, audioContext.currentTime); 
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + decayTime);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + duration);
            }
        }

        // --- èƒŒæ™¯éŸ³æ¨‚æ§åˆ¶ ---
        const bgmAudio = document.getElementById('background-music');
        const musicToggleButton = document.getElementById('music-toggle-button');
        const musicVolumeSlider = document.getElementById('music-volume-slider');
        
        // å‡½æ•¸ï¼šæ›´æ–°éŸ³æ¨‚æŒ‰éˆ•åœ–æ¨™
        function updateMusicButtonIcon() {
            if (bgmAudio.paused || bgmAudio.volume === 0) {
                musicToggleButton.innerHTML = '<i class="fas fa-volume-mute"></i>';
            } else {
                musicToggleButton.innerHTML = '<i class="fas fa-volume-up"></i>';
            }
        }

        // å‡½æ•¸ï¼šæ›´æ–°éŸ³é‡æ»‘æ¡¿çš„å¡«è‰²
        function updateVolumeSliderFill() {
            const volume = parseFloat(musicVolumeSlider.value);
            const min = parseFloat(musicVolumeSlider.min);
            const max = parseFloat(musicVolumeSlider.max);
            const percentage = ((volume - min) / (max - min)) * 100;

            musicVolumeSlider.style.background = `linear-gradient(to right, #f9d71c 0%, #f9d71c ${percentage}%, #4b5563 ${percentage}%, #4b5563 100%)`;
        }

        // æ’­æ”¾/æš«åœåŠŸèƒ½
        function toggleBackgroundMusic() {
            if (bgmAudio.paused) {
                // å¦‚æœéŸ³æ¨‚å·²æš«åœï¼Œå˜—è©¦æ’­æ”¾
                bgmAudio.play().then(() => {
                    backgroundMusicPlayedOnceSuccessfully = true;
                    updateMusicButtonIcon();
                }).catch(e => {
                    console.error("èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å¤±æ•— (ç”¨æˆ¶é»æ“Š):", e);
                    updateMusicButtonIcon(); // å³ä½¿æ’­æ”¾å¤±æ•—ï¼Œä¹Ÿæ›´æ–°åœ–æ¨™
                });
            } else {
                // å¦‚æœéŸ³æ¨‚æ­£åœ¨æ’­æ”¾ï¼Œæš«åœå®ƒ
                bgmAudio.pause();
                updateMusicButtonIcon();
            }
        }
        musicToggleButton.onclick = toggleBackgroundMusic;

        // éŸ³é‡èª¿æ•´åŠŸèƒ½
        musicVolumeSlider.oninput = () => {
            bgmAudio.volume = parseFloat(musicVolumeSlider.value);
            updateMusicButtonIcon();    // æ›´æ–°éœéŸ³/ééœéŸ³åœ–æ¨™
            updateVolumeSliderFill();   // æ›´æ–°æ»‘æ¡¿å¡«è‰²

            // å¦‚æœéŸ³é‡å¾0èª¿å›é0ï¼Œä¸”éŸ³æ¨‚ç•¶å‰å·²æš«åœï¼Œå˜—è©¦æ’­æ”¾ (å¦‚åŒç”¨æˆ¶é»æ“Šæ’­æ”¾)
            if (bgmAudio.volume > 0 && bgmAudio.paused) {
                bgmAudio.play().then(() => {
                    backgroundMusicPlayedOnceSuccessfully = true;
                    updateMusicButtonIcon();
                }).catch(e => {
                    console.warn("èƒŒæ™¯éŸ³æ¨‚ç„¡æ³•åœ¨èª¿æ•´éŸ³é‡å¾Œæ’­æ”¾:", e);
                    updateMusicButtonIcon(); // å¤±æ•—å¾Œä¹Ÿæ›´æ–°åœ–æ¨™
                });
            }
        };

        // ç¢ºä¿åœ¨ä»»ä½•ç”¨æˆ¶äº¤äº’å¾ŒèƒŒæ™¯éŸ³æ¨‚èƒ½å¤ æ’­æ”¾æˆ–æ¢å¾©
        function ensureBackgroundMusicPlays() {
            // åªæœ‰ç•¶éŸ³æ¨‚ç•¶å‰æ˜¯æš«åœç‹€æ…‹ï¼Œä¸”éŸ³é‡ä¸æ˜¯0æ™‚æ‰å˜—è©¦æ’­æ”¾
            if (bgmAudio.paused && bgmAudio.volume > 0) { 
                bgmAudio.play().then(() => {
                    backgroundMusicPlayedOnceSuccessfully = true; // æ¨™è¨˜ç‚ºå·²æˆåŠŸæ’­æ”¾é
                    updateMusicButtonIcon();
                }).catch(e => {
                    console.warn("èƒŒæ™¯éŸ³æ¨‚æ¢å¾©æ’­æ”¾å¤±æ•— (å¯èƒ½è¢«ç€è¦½å™¨é˜»æ“‹):", e.message);
                    // å³ä½¿æ’­æ”¾å¤±æ•—ï¼Œä¹Ÿæ›´æ–°åœ–æ¨™ä»¥ç¢ºä¿ç‹€æ…‹æ­£ç¢º (å¯èƒ½é‚„æ˜¯éœéŸ³)
                    updateMusicButtonIcon(); 
                });
            } else if (!bgmAudio.paused && bgmAudio.volume > 0) {
                // å¦‚æœéŸ³æ¨‚å·²ç¶“åœ¨æ’­æ”¾ä¸”æœ‰éŸ³é‡ï¼Œå‰‡æ¨™è¨˜ç‚ºæˆåŠŸæ’­æ”¾é
                backgroundMusicPlayedOnceSuccessfully = true;
            }
            // å¦‚æœéŸ³æ¨‚å·²åœ¨æ’­æ”¾ï¼Œæˆ–è€…éŸ³é‡ç‚º0ï¼Œå‰‡ä¸éœ€è¦é¡å¤–è™•ç†
        }


        // --- é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–é †åº ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. è¨­å®šåˆå§‹éŸ³é‡
            bgmAudio.volume = parseFloat(musicVolumeSlider.value);
            // 2. æ›´æ–°éŸ³é‡æ»‘æ¡¿å¡«è‰² (é€™æ¨£å³ä½¿è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œæ»‘æ¡¿ä¹Ÿæ˜¯æ­£ç¢ºçš„)
            updateVolumeSliderFill();
            // 3. é è¨­åœ–æ¨™ç‚ºæ’­æ”¾ç‹€æ…‹ (å³ä½¿å¯¦éš›å¯èƒ½è¢«é˜»æ“‹ï¼Œä¹Ÿç¬¦åˆç”¨æˆ¶æœŸæœ›)
            musicToggleButton.innerHTML = '<i class="fas fa-volume-up"></i>';

            // 4. å˜—è©¦åœ¨é é¢è¼‰å…¥æ™‚è‡ªå‹•æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
            //    ç€è¦½å™¨å¯èƒ½æœƒé˜»æ“‹æ­¤æ“ä½œï¼Œä½†é€™ç¬¦åˆã€Œé è¨­è‡ªå‹•æ’­æ”¾ã€çš„éœ€æ±‚
            bgmAudio.play().then(() => {
                backgroundMusicPlayedOnceSuccessfully = true; // è‡ªå‹•æ’­æ”¾æˆåŠŸ
                updateMusicButtonIcon(); // ç¢ºä¿åœ–æ¨™æ­£ç¢º
            }).catch(e => {
                console.warn("èƒŒæ™¯éŸ³æ¨‚è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹ (é¦–æ¬¡è¼‰å…¥):", e.message);
                // å¦‚æœè‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹ï¼Œ`bgmAudio.paused` æœƒæ˜¯ `true`ã€‚
                // æˆ‘å€‘ä¸åœ¨æ­¤è™•ç«‹å³å°‡åœ–æ¨™åˆ‡æ›ç‚ºéœéŸ³ï¼Œè®“å®ƒä¿æŒã€ŒéŸ³é‡é–‹å•Ÿã€çš„è¦–è¦ºç‹€æ…‹ï¼Œ
                // ç­‰å¾…ç”¨æˆ¶äº’å‹•å¾Œ `ensureBackgroundMusicPlays()` ä¾†çœŸæ­£å•Ÿå‹•éŸ³æ¨‚ã€‚
            });
        });


        // --- è³‡ç”¢è¼‰å…¥ç®¡ç† ---
        const ORIGINAL_IMAGE_DEFINITIONS = {
            EGG: { path: 'item/egg.svg', size: 35 * SCALE_FACTOR, speed: 2.0, name: 'çˆ†æ°£ç‚¸è›‹', iconClass: 'fas fa-bomb' }, 
            MOON: { path: 'item/moon.svg', size: 30 * SCALE_FACTOR, speed: 0.5, name: 'æœˆäº®', iconClass: 'fas fa-moon' }, 
            MOONCAKE: { path: 'item/mooncake.svg', size: 22.5 * SCALE_FACTOR, speed: 1.2, name: 'æœˆé¤…', iconClass: 'fas fa-cookie-bite' }, 
            POMELO: { path: 'item/pomelo.svg', size: 25 * SCALE_FACTOR, speed: 1.5, name: 'æŸšå­', iconClass: 'fas fa-lemon' }, 
            RABBIT: { path: 'item/rabbit.svg', size: 20 * SCALE_FACTOR, speed: 1.0, name: 'ç‰å…”', iconClass: 'fas fa-rabbit' }, 
            MATCHA: { path: 'item/matcha.svg', size: 20 * SCALE_FACTOR, speed: 0.8, name: 'æŠ¹èŒ¶', iconClass: 'fas fa-tea' }, 
            TIGER: { path: 'item/tiger.svg', size: 25 * SCALE_FACTOR, speed: 2.5, name: 'è€è™', iconClass: 'fas fa-tiger' }, 
            HAPPY_CARP: { path: 'item/gms.svg', size: 27.5 * SCALE_FACTOR, speed: 1.0, name: 'å¿«æ¨‚é¯‰é­š', isBonus: true, iconClass: 'fas fa-fish-fins' }, 
            BUBBLETEA: { path: 'item/bubbletea.svg', size: 28 * SCALE_FACTOR, speed: 1.3, name: 'çç å¥¶èŒ¶', iconClass: 'fas fa-bubble-tea' }, 
            DANGO: { path: 'item/dango.svg', size: 22 * SCALE_FACTOR, speed: 0.7, name: 'ç³¯ç±³ç³°å­', iconClass: 'fas fa-cookie' }, 
        };

        const LOADED_IMAGES = {}; 
        let fontAwesomeLoaded = false; 

        const totalAssetsToLoad = Object.keys(ORIGINAL_IMAGE_DEFINITIONS).length + 1; 
        let assetsLoadedProgress = 0; 

        function checkAllAssetsLoaded() {
            assetsLoadedProgress++;
            if (assetsLoadedProgress === totalAssetsToLoad) {
                for (const key in ORIGINAL_IMAGE_DEFINITIONS) {
                    OBJECT_TYPES[key] = { 
                        ...ORIGINAL_IMAGE_DEFINITIONS[key], 
                        img: LOADED_IMAGES[key],
                        miniHtmlImg: `<img src="${ORIGINAL_IMAGE_DEFINITIONS[key].path}" alt="${ORIGINAL_IMAGE_DEFINITIONS[key].name}" class="item-icon-inline">`
                    };
                }
                initGame();
                requestAnimationFrame(drawGame);
            }
        }

        document.fonts.ready.then(() => {
            fontAwesomeLoaded = true;
            checkAllAssetsLoaded();
        }).catch(err => {
            console.error("Font Awesome å­—é«”è¼‰å…¥å¤±æ•—:", err);
            fontAwesomeLoaded = true;
            checkAllAssetsLoaded();
        });

        for (const key in ORIGINAL_IMAGE_DEFINITIONS) {
            const img = new Image();
            img.src = ORIGINAL_IMAGE_DEFINITIONS[key].path;
            img.onload = () => {
                LOADED_IMAGES[key] = img;
                checkAllAssetsLoaded();
            };
            img.onerror = () => {
                console.warn(`åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${ORIGINAL_IMAGE_DEFINITIONS[key].path}ã€‚æ­¤ç‰©ä»¶å¯èƒ½ç„¡æ³•é¡¯ç¤ºã€‚`);
                LOADED_IMAGES[key] = null;
                checkAllAssetsLoaded();
            };
        }

        const OBJECT_TYPES = {}; 

        // --- é—œå¡æ•¸æ“š (å·²æ›´æ–°ç¬¬ä¹é—œèˆ‡ç¬¬åé—œé›£åº¦) ---
        const LEVELS = [
            {
                name: "å°‹æ‰¾æœˆäº®ä¹‹å…‰",
                duration: 12,
                required: ['MOON'],
                forbidden: ['TIGER', 'EGG'], 
                objectCount: 8,
                speedMultiplier: 1.0,
            },
            {
                name: "ç‰å…”èˆ‡æœˆé¤…",
                duration: 10,
                required: ['RABBIT', 'MOONCAKE'],
                forbidden: ['TIGER', 'EGG'],
                objectCount: 12,
                speedMultiplier: 1.2,
            },
            {
                name: "æ¸…æ¶¼é£²å“",
                duration: 10,
                required: ['BUBBLETEA', 'POMELO'], 
                forbidden: ['TIGER'],
                objectCount: 13,
                speedMultiplier: 1.3,
            },
            {
                name: "ä¸­ç§‹ç”œé»",
                duration: 9,
                required: ['MOONCAKE', 'DANGO'], 
                forbidden: ['EGG'],
                objectCount: 14,
                speedMultiplier: 1.4,
            },
            {
                name: "åœ“æ»¿è±æ”¶å¤œ", 
                duration: 12, 
                required: ['MOON', 'RABBIT', 'BUBBLETEA'], 
                forbidden: ['TIGER', 'EGG'], 
                objectCount: 16,
                speedMultiplier: 1.3, 
            },
            {
                name: "æŠ¹èŒ¶æ™‚å…‰",
                duration: 10,
                required: ['MATCHA', 'DANGO'],
                forbidden: ['TIGER', 'EGG', 'POMELO'], 
                objectCount: 15,
                speedMultiplier: 1.5,
            },
            {
                name: "æœˆä¸‹èŒ¶æœƒ",
                duration: 10,
                required: ['MOON', 'BUBBLETEA', 'MATCHA'],
                forbidden: ['TIGER', 'EGG'],
                objectCount: 17,
                speedMultiplier: 1.6,
            },
            {
                name: "æŸšå­ç››å®´", 
                duration: 10, 
                required: ['POMELO', 'MOONCAKE'],
                forbidden: ['TIGER', 'EGG'], 
                objectCount: 16, 
                speedMultiplier: 1.5, 
            },
            {
                name: "è¿½é€æœˆå…‰å…” (èª¿æ•´å¾Œ)", // æ¨™è¨»ç‚ºèª¿æ•´å¾Œ
                duration: 10, // ç”± 8 èª¿æ•´ç‚º 10 ç§’
                required: ['MOON', 'RABBIT', 'DANGO'],
                forbidden: ['TIGER', 'EGG', 'BUBBLETEA'], // ç”± 4 é …èª¿æ•´ç‚º 3 é … (ç§»é™¤ MATCHA)
                objectCount: 18, // ç”± 20 èª¿æ•´ç‚º 18
                speedMultiplier: 1.7, // ç”± 1.8 èª¿æ•´ç‚º 1.7
            },
            {
                name: "çµ‚æ¥µç¥æ”æ‰‹ (èª¿æ•´å¾Œ)", // æ¨™è¨»ç‚ºèª¿æ•´å¾Œ
                duration: 10, // ç”± 8 èª¿æ•´ç‚º 10 ç§’
                required: ['MOON', 'RABBIT', 'MOONCAKE', 'POMELO'], 
                forbidden: ['TIGER', 'EGG'], // ç”± 5 é …å¤§å¹…èª¿æ•´ç‚º 2 é … (ç§»é™¤ MATCHA, BUBBLETEA, DANGO)
                objectCount: 22, 
                speedMultiplier: 2.0, 
            },
        ];

        // --- éŠæˆ²å°è±¡é¡åˆ¥ ---
        class GameObject {
            constructor(typeId) {
                const typeDef = OBJECT_TYPES[typeId]; 
                this.typeId = typeId;
                this.img = typeDef.img; 
                this.size = typeDef.size; 
                this.x = Math.random() * CANVAS_WIDTH;
                this.y = Math.random() < 0.5 ? -this.size : CANVAS_HEIGHT + this.size; 
                this.baseSpeed = typeDef.speed;
                this.vx = (Math.random() - 0.5) * 0.5; 
                this.vy = this.y < CANVAS_HEIGHT / 2 ? 1 : -1; 
                this.isBonus = typeDef.isBonus || false; 
                this.name = typeDef.name; 
                this.iconClass = typeDef.iconClass; 
                this.miniHtmlImg = typeDef.miniHtmlImg; 
            }

            isVisibleOnCanvas() {
                return (
                    this.x + this.size / 2 > 0 && 
                    this.x - this.size / 2 < CANVAS_WIDTH && 
                    this.y + this.size / 2 > 0 && 
                    this.y - this.size / 2 < CANVAS_HEIGHT
                );
            }

            update(speedMultiplier) {
                if (objectsAreFrozen) return; 

                this.x += this.vx * this.baseSpeed * speedMultiplier;
                this.y += this.vy * this.baseSpeed * speedMultiplier;

                if (this.x - this.size / 2 < 0 || this.x + this.size / 2 > CANVAS_WIDTH) {
                    this.vx *= -1;
                    if (this.x - this.size / 2 < 0) this.x = this.size / 2;
                    if (this.x + this.size / 2 > CANVAS_WIDTH) this.x = CANVAS_WIDTH - this.size / 2;
                }
            }

            isOffScreen() {
                if (objectsAreFrozen) return false;
                return (this.y < -this.size * 2 || this.y > CANVAS_HEIGHT + this.size * 2);
            }

            draw() {
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.globalAlpha = 1.0; 

                if (this.img) { 
                    ctx.drawImage(this.img, this.x - this.size / 2, this.y - this.size / 2, this.size, this.size);
                } else {
                    ctx.fillStyle = 'gray';
                    ctx.fillRect(this.x - this.size / 2, this.y - this.size / 2, this.size, this.size);
                    ctx.fillStyle = 'white';
                    ctx.font = `${this.size/3}px Arial`;
                    ctx.fillText(this.typeId, this.x, this.y);
                }
                ctx.restore();
            }
        }

        // --- éŠæˆ²é‚è¼¯å‡½æ•¸ ---

        function resizeCanvas() {
            const container = canvas.parentElement;
            CANVAS_WIDTH = container.clientWidth;
            CANVAS_HEIGHT = 400; 
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); 

        function generateRandomGameObject() {
            let newTypeId;
            const rand = Math.random();
            if (rand < 0.1) { 
                newTypeId = 'HAPPY_CARP';
            } else {
                const availableTypes = Object.keys(OBJECT_TYPES).filter(id => id !== 'HAPPY_CARP'); 
                newTypeId = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            }
            return new GameObject(newTypeId);
        }

        function initGame() {
            score = 0;
            currentLevelIndex = 0;
            SCORE_DISPLAY.textContent = score;
            GAME_MESSAGE.textContent = 'é»æ“Šé–‹å§‹æŒ‰éˆ•ï¼Œæ•æ‰ä¸­ç§‹å¤œæ™¯ï¼';
            START_BUTTON.textContent = 'é–‹å§‹æŒ‘æˆ°';
            START_BUTTON.onclick = startGame; 
            GAME_OVERLAY.classList.remove('hidden'); 
            
            gameState = 'ready';
            objectsAreFrozen = false; 
            highlightEffect = null; 
            clearScreen();
            updateMissionDisplay(LEVELS[currentLevelIndex]);
        }

        function startGame() {
            ensureBackgroundMusicPlays(); // å˜—è©¦æ’­æ”¾èƒŒæ™¯éŸ³æ¨‚
            currentLevelIndex = 0; 
            score = 0;
            SCORE_DISPLAY.textContent = score;
            initLevel(currentLevelIndex);
        }

        // æ¢å¾©éŠæˆ²ç§»å‹•ç‹€æ…‹å’Œè¨ˆæ™‚å™¨
        function resumeCapturing() {
            ensureBackgroundMusicPlays(); // ç¢ºä¿éŸ³æ¨‚ç¹¼çºŒæ’­æ”¾
            objectsAreFrozen = false; 
            GAME_OVERLAY.classList.add('hidden'); 
            GAME_MESSAGE.textContent = `é—œå¡ ${currentLevelIndex + 1}: ${LEVELS[currentLevelIndex].name} - å€’æ•¸ç¹¼çºŒ!`; 
            highlightEffect = null; 
            startTimer(false); 
        }


        function initLevel(levelIndex) {
            ensureBackgroundMusicPlays(); // ç¢ºä¿éŸ³æ¨‚ç¹¼çºŒæ’­æ”¾
            if (levelIndex >= LEVELS.length) {
                gameState = 'win';
                clearInterval(timerInterval);
                GAME_MESSAGE.innerHTML = `<span class="text-yellow-300 font-bold">ğŸ‰ æ­å–œ! å®Œæˆæ‰€æœ‰æŒ‘æˆ°! ç¸½å¾—åˆ†: ${score}</span>`;
                START_BUTTON.textContent = 'é‡æ–°é–‹å§‹ (é—œå¡ 1)';
                START_BUTTON.onclick = startGame;
                GAME_OVERLAY.classList.remove('hidden'); 
                objectsAreFrozen = true; 
                return;
            }

            const level = LEVELS[levelIndex];
            currentLevelIndex = levelIndex; 
            
            gameObjects = []; 
            timeLeft = level.duration;
            TIMER_DISPLAY.textContent = timeLeft.toFixed(1);
            
            for (let i = 0; i < level.objectCount; i++) {
                gameObjects.push(generateRandomGameObject());
            }

            level.required.forEach(reqId => {
                if (!gameObjects.some(obj => obj.typeId === reqId)) {
                    const availableNeutralOrBonusIndices = gameObjects.map((obj, idx) => {
                        const isRequired = level.required.includes(obj.typeId);
                        const isForbidden = level.forbidden.includes(obj.typeId);
                        if (!isRequired && !isForbidden) {
                            return idx;
                        }
                        return -1;
                    }).filter(idx => idx !== -1);
                    
                    if (availableNeutralOrBonusIndices.length > 0) {
                        const indexToReplace = availableNeutralOrBonusIndices[Math.floor(Math.random() * availableNeutralOrBonusIndices.length)];
                        gameObjects[indexToReplace] = new GameObject(reqId);
                    } else {
                        gameObjects.push(new GameObject(reqId));
                    }
                }
            });

            updateMissionDisplay(level);
            LEVEL_DISPLAY.textContent = levelIndex + 1;
            GAME_MESSAGE.textContent = `é—œå¡ ${levelIndex + 1}: ${level.name} - å€’æ•¸é–‹å§‹!`; 
            GAME_OVERLAY.classList.add('hidden'); 
            
            gameState = 'playing';
            objectsAreFrozen = false; 
            highlightEffect = null; 
            startTimer(true); 
        }

        function updateMissionDisplay(level) {
            const getMissionItemsDisplay = (itemIds) => itemIds.map(id => {
                const objDef = OBJECT_TYPES[id]; 
                return `<span class="mission-item-wrapper">${objDef.miniHtmlImg} ${objDef.name}</span>`;
            }).join(''); 
            
            TARGETS_DISPLAY.innerHTML = getMissionItemsDisplay(level.required);
            FORBIDDEN_DISPLAY.innerHTML = getMissionItemsDisplay(level.forbidden);
            LEVEL_NAME_DISPLAY.textContent = `é™æ™‚ ${level.duration} ç§’ï¼Œæ‹åˆ°ä¸€æ¬¡å³å¯æ™‰ç´šï¼`;
        }

        // `reset` åƒæ•¸ç”¨æ–¼æ§åˆ¶æ˜¯å¦å¾é ­é–‹å§‹è¨ˆæ™‚ (true) æˆ–å¾ä¸Šæ¬¡æš«åœé»æ¢å¾© (false)
        function startTimer(reset = true) {
            clearInterval(timerInterval);
            let startTime;

            if (reset) {
                timeLeft = LEVELS[currentLevelIndex].duration; 
                startTime = performance.now();
            } else {
                startTime = performance.now() - (LEVELS[currentLevelIndex].duration - timeLeft) * 1000;
            }
            
            TIMER_DISPLAY.textContent = timeLeft.toFixed(1); 

            timerInterval = setInterval(() => {
                if (objectsAreFrozen) {
                    startTime = performance.now() - (LEVELS[currentLevelIndex].duration - timeLeft) * 1000; 
                    return; 
                }

                const elapsed = (performance.now() - startTime) / 1000;
                timeLeft = LEVELS[currentLevelIndex].duration - elapsed;
                
                if (timeLeft <= 0) {
                    timeLeft = 0;
                    clearInterval(timerInterval);
                    TIMER_DISPLAY.textContent = '0.0';
                    checkLevelEnd(false); 
                    return;
                }
                
                TIMER_DISPLAY.textContent = timeLeft.toFixed(1);
            }, 100);
        }

        function displayBonusMessage(x, y, points) {
            bonusMessages.push({
                x: x,
                y: y,
                text: `+${points} BONUS!`,
                startTime: Date.now(),
                color: '#00ffc0' 
            });
            playSound(600, 0.1, 'sine', 0.05); // çå‹µéŸ³æ•ˆ
        }

        function handleCapture(x, y) { 
            if (gameState !== 'playing' || objectsAreFrozen) return; 

            captureEffect = { x, y, startTime: Date.now() };
            playSound(300, 0.05, 'square', 0.02); // å¿«ç…§éŸ³æ•ˆ
            ensureBackgroundMusicPlays(); // é»æ“Šç•«å¸ƒä¹Ÿå˜—è©¦æ’­æ”¾éŸ³æ¨‚

            const level = LEVELS[currentLevelIndex];
            let visibleTargetsDetected = new Set();    
            let visibleForbiddenDetected = new Set();  
            let visibleBonusItemsDetected = [];        
            
            let itemsToHighlight = []; 

            for (const obj of gameObjects) {
                if (obj.isVisibleOnCanvas()) { 
                    if (level.required.includes(obj.typeId)) {
                        visibleTargetsDetected.add(obj.typeId);
                        itemsToHighlight.push({ obj: obj, color: 'green' }); 
                    } else if (level.forbidden.includes(obj.typeId)) {
                        visibleForbiddenDetected.add(obj.typeId);
                        itemsToHighlight.push({ obj: obj, color: 'red' }); 
                    } else if (obj.typeId === 'HAPPY_CARP' && obj.isBonus) {
                        visibleBonusItemsDetected.push(obj);
                    }
                }
            }

            let isCurrentSnapshotSuccessful = false;
            let failureReason = null;

            if (visibleForbiddenDetected.size > 0) {
                failureReason = `æ•æ‰åˆ°ç¦å¿Œç‰©å“ï¼š${Array.from(visibleForbiddenDetected).map(id => OBJECT_TYPES[id].name).join('ã€')}ï¼`;
                itemsToHighlight = itemsToHighlight.filter(item => item.color === 'red'); 
                
            } else { 
                const currentLevelRequiredTargets = LEVELS[currentLevelIndex].required;
                const allRequiredTargetsVisible = currentLevelRequiredTargets.length > 0 && currentLevelRequiredTargets.every(reqId => visibleTargetsDetected.has(reqId));

                if (allRequiredTargetsVisible) {
                    isCurrentSnapshotSuccessful = true; 
                    itemsToHighlight = itemsToHighlight.filter(item => item.color === 'green'); 

                } else {
                    isCurrentSnapshotSuccessful = false; 
                    itemsToHighlight = []; 
                }
            }
            
            objectsAreFrozen = true; 

            if (isCurrentSnapshotSuccessful || failureReason !== null) {
                if (isCurrentSnapshotSuccessful) {
                    for (const bonusItem of visibleBonusItemsDetected) {
                        score += BONUS_ITEM_SCORE;
                        SCORE_DISPLAY.textContent = score;
                        displayBonusMessage(bonusItem.x, bonusItem.y, BONUS_ITEM_SCORE);
                    }
                }
                checkLevelEnd(isCurrentSnapshotSuccessful, failureReason, itemsToHighlight);
            } else {
                GAME_MESSAGE.innerHTML = `<span class="text-gray-400">å¿«ç…§å®Œæˆï¼é‚„éœ€åŠªåŠ›ï¼</span>`;
                START_BUTTON.textContent = 'ç¹¼çºŒæ•æ‰';
                START_BUTTON.onclick = resumeCapturing;
                GAME_OVERLAY.classList.remove('hidden'); 
                highlightEffect = null; 
            }
        }


        function checkLevelEnd(success, reason = null, itemsToHighlight = []) {
            clearInterval(timerInterval); 
            GAME_OVERLAY.classList.remove('hidden'); 

            highlightEffect = { type: success ? 'success' : 'failure', items: itemsToHighlight, startTime: Date.now() }; 

            if (success) {
                gameState = 'win';
                GAME_MESSAGE.innerHTML = `<span class="text-green-400 font-bold"><i class="fas fa-trophy"></i> æ•æ‰æˆåŠŸ! æ™‰ç´šä¸‹ä¸€é—œ!</span>`;
                START_BUTTON.textContent = 'ä¸‹ä¸€é—œ';
                START_BUTTON.onclick = () => {
                    highlightEffect = null; // æ¸…é™¤é«˜äº®
                    initLevel(currentLevelIndex + 1);
                };
                playSound(800, 0.15, 'sine', 0.1); // æˆåŠŸéŸ³æ•ˆ
                
            } else {
                gameState = 'lose';
                GAME_MESSAGE.innerHTML = `<span class="text-red-400 font-bold"><i class="fas fa-times-circle"></i> ä»»å‹™å¤±æ•—!</span> ${reason ? 'åŸå› : ' + reason : 'æ™‚é–“ç”¨ç›¡äº†!'}`;
                START_BUTTON.textContent = 'å†è©¦ä¸€æ¬¡';
                START_BUTTON.onclick = () => {
                    highlightEffect = null; // æ¸…é™¤é«˜äº®
                    initLevel(currentLevelIndex);
                };
                playSound(150, 0.2, 'square', 0.1); // å¤±æ•—éŸ³æ•ˆ
            }
        }


        // --- ç¹ªåœ–èˆ‡å‹•ç•« ---

        function clearScreen() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            ctx.fillStyle = '#1c1c4e';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        }

        function drawGame() {
            clearScreen();

            const level = LEVELS[currentLevelIndex];
            const speedMultiplier = level ? level.speedMultiplier : 1.0;
            
            for (let i = gameObjects.length - 1; i >= 0; i--) {
                const obj = gameObjects[i];
                obj.update(speedMultiplier); 
                obj.draw();
                
                if (!objectsAreFrozen && obj.isOffScreen()) { 
                    gameObjects.splice(i, 1);
                    gameObjects.push(generateRandomGameObject());
                }
            }
            
            if (captureEffect) {
                const elapsed = Date.now() - captureEffect.startTime;
                const duration = 200; 
                
                if (elapsed < duration) {
                    const alpha = 1 - (elapsed / duration); 
                    ctx.globalAlpha = alpha;
                    
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
                    
                    ctx.globalAlpha = 1.0;
                } else {
                    captureEffect = null;
                }
            }

            for (let i = bonusMessages.length - 1; i >= 0; i--) {
                const msg = bonusMessages[i];
                const elapsed = Date.now() - msg.startTime;
                const duration = 1000; 

                if (elapsed < duration) {
                    const alpha = 1 - (elapsed / duration);
                    ctx.save();
                    ctx.font = 'bold 24px Inter';
                    ctx.fillStyle = msg.color;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.globalAlpha = alpha;
                    ctx.fillText(msg.text, msg.x, msg.y - (elapsed / 20)); 
                    ctx.restore();
                } else {
                    bonusMessages.splice(i, 1);
                }
            }

            // é«˜äº®æ•ˆæœä¸å†è‡ªè¡Œæ¶ˆå¤±ï¼Œè€Œæ˜¯ç­‰å¾…æŒ‰éˆ•äº’å‹•
            if (highlightEffect) {
                ctx.save();
                ctx.globalAlpha = 1.0; 
                ctx.lineWidth = 4;

                for (const item of highlightEffect.items) {
                    if (item.obj.isVisibleOnCanvas()) { 
                        ctx.strokeStyle = item.color; 
                        ctx.beginPath();
                        ctx.arc(item.obj.x, item.obj.y, item.obj.size / 2 + 10, 0, Math.PI * 2); 
                        ctx.stroke();
                    }
                }
                ctx.restore();
            }

            requestAnimationFrame(drawGame);
        }

        // --- è¼¸å…¥è™•ç† ---
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e); 
            handleCapture(pos.x, pos.y);
        });
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const pos = getMousePos(e); 
            handleCapture(pos.x, pos.y);
        }, { passive: false });

        // --- éŠæˆ²èªªæ˜æ›¸åŠŸèƒ½ ---
        function toggleInstructions() {
            const modal = document.getElementById('instructions-modal');
            modal.classList.toggle('hidden');
        }

        // éŠæˆ²çš„åˆå§‹åŒ–å’Œç¹ªåœ–å¾ªç’°ç¾åœ¨ç”± checkAllAssetsLoaded() æ§åˆ¶
        // ç¢ºä¿æ‰€æœ‰è³‡ç”¢è¼‰å…¥å¾Œæ‰å•Ÿå‹•éŠæˆ²
    </script>
</body>
</html>